<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D AI Magic 8 Ball</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@600&display=swap');
    html, body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #eee;
      user-select: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    #overlay {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      z-index: 10;
      pointer-events: auto;
    }
    #question {
      font-size: 20px;
      font-weight: 600;
      padding: 14px 18px;
      width: 320px;
      max-width: 90vw;
      border-radius: 12px;
      border: none;
      outline: none;
      background: #111;
      color: #eee;
      box-shadow: 0 0 8px #0000ff66;
      text-align: center;
      transition: box-shadow 0.3s ease;
    }
    #question:focus {
      box-shadow: 0 0 15px #007bffcc;
    }
    button {
      font-size: 20px;
      font-weight: 700;
      padding: 14px 24px;
      margin-left: 12px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: linear-gradient(145deg, #0057ff, #003dbb);
      color: #fff;
      box-shadow: 0 0 12px #0057ffcc;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    button:hover, button:focus {
      background: linear-gradient(145deg, #003dbb, #001f70);
      box-shadow: 0 0 20px #0040ffee;
    }
  </style>
</head>
<body>
  <div id="overlay">
    <input id="question" type="text" placeholder="Ask your question..." autocomplete="off" />
    <button onclick="askQuestion()">Ask</button>
  </div>
  <canvas id="canvas"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r155/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/OrbitControls.min.js"></script>

  <script>
    // Scene setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.5, 5);

    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("canvas"), antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x000000);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.1;
    controls.minDistance = 3;
    controls.maxDistance = 10;
    controls.enablePan = false;

    // Lights
    const pointLight = new THREE.PointLight(0xffffff, 1.2);
    pointLight.position.set(5, 5, 5);
    scene.add(pointLight);
    scene.add(new THREE.AmbientLight(0x222222));

    // Magic 8 Ball (matte black sphere)
    const ballGeometry = new THREE.SphereGeometry(1.5, 128, 128);
    const ballMaterial = new THREE.MeshPhysicalMaterial({
      color: 0x111111,
      metalness: 0.5,
      roughness: 0.7,
      clearcoat: 1,
      clearcoatRoughness: 0.1,
      reflectivity: 0.5,
    });
    const ball = new THREE.Mesh(ballGeometry, ballMaterial);
    scene.add(ball);

    // Front window circle (glowing)
    const windowGeometry = new THREE.CircleGeometry(0.65, 64);
    const windowMaterial = new THREE.MeshPhysicalMaterial({
      color: 0x0022ff,
      emissive: 0x0044ff,
      emissiveIntensity: 0.5,
      roughness: 0.2,
      metalness: 0.3,
      transparent: true,
      opacity: 0.85,
      side: THREE.DoubleSide,
      clearcoat: 1,
      clearcoatRoughness: 0.1,
    });
    const ballWindow = new THREE.Mesh(windowGeometry, windowMaterial);
    ballWindow.position.z = 1.52;
    ballWindow.rotation.x = -Math.PI / 2;
    ball.add(ballWindow);

    // Internal icosahedron (the die)
    const dieGeometry = new THREE.IcosahedronGeometry(0.6);
    const dieMaterial = new THREE.MeshPhysicalMaterial({
      color: 0x0033cc,
      metalness: 0.7,
      roughness: 0.3,
      clearcoat: 1,
      clearcoatRoughness: 0.1,
      flatShading: true,
      emissive: 0x001122,
      emissiveIntensity: 0.6
    });
    const die = new THREE.Mesh(dieGeometry, dieMaterial);
    scene.add(die);

    // Create a canvas texture to display the answer text on the window
    const textCanvas = document.createElement('canvas');
    textCanvas.width = 512;
    textCanvas.height = 512;
    const ctx = textCanvas.getContext('2d');
    const textTexture = new THREE.CanvasTexture(textCanvas);

    // Plane to show answer text, positioned just in front of window
    const textPlaneMaterial = new THREE.MeshBasicMaterial({ map: textTexture, transparent: true });
    const textPlane = new THREE.Mesh(new THREE.PlaneGeometry(1.2, 1.2), textPlaneMaterial);
    textPlane.position.z = 1.53;
    ball.add(textPlane);

    function drawAnswer(text) {
      ctx.clearRect(0, 0, textCanvas.width, textCanvas.height);

      // Background glow
      const gradient = ctx.createRadialGradient(textCanvas.width/2, textCanvas.height/2, 50, textCanvas.width/2, textCanvas.height/2, 220);
      gradient.addColorStop(0, 'rgba(0,68,255,0.8)');
      gradient.addColorStop(1, 'rgba(0,0,0,0)');

      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, textCanvas.width, textCanvas.height);

      // White text with shadow
      ctx.fillStyle = 'white';
      ctx.font = 'bold 48px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(0,0,0,0.7)';
      ctx.shadowBlur = 10;
      ctx.fillText(text, textCanvas.width/2, textCanvas.height/2);

      textTexture.needsUpdate = true;
    }

    // Standard 20 Magic 8 Ball answers
    const standardAnswers = [
      "It is certain", "It is decidedly so", "Without a doubt", "Yes, definitely",
      "You may rely on it", "As I see it, yes", "Most likely", "Outlook good",
      "Yes", "Signs point to yes", "Reply hazy, try again", "Ask again later",
      "Better not tell you now", "Cannot predict now", "Concentrate and ask again",
      "Don't count on it", "My reply is no", "My sources say no",
      "Outlook not so good", "Very doubtful"
    ];

    // Animate die rotation (spin + slow stop)
    function animateDie(answer, onComplete) {
      const startRot = die.rotation.clone();
      const spins = 4 + Math.random() * 3; // Spins between 4-7
      const targetRot = new THREE.Euler(
        startRot.x + Math.PI * 2 * spins * (Math.random() > 0.5 ? 1 : -1),
        startRot.y + Math.PI * 2 * spins * (Math.random() > 0.5 ? 1 : -1),
        startRot.z + Math.PI * 2 * spins * (Math.random() > 0.5 ? 1 : -1)
      );

      let progress = 0;
      const duration = 1500; // ms
      const startTime = performance.now();

      function spin() {
        const now = performance.now();
        progress = (now - startTime) / duration;
        if (progress > 1) progress = 1;

        die.rotation.x = THREE.MathUtils.lerp(startRot.x, targetRot.x, easeOutCubic(progress));
        die.rotation.y = THREE.MathUtils.lerp(startRot.y, targetRot.y, easeOutCubic(progress));
        die.rotation.z = THREE.MathUtils.lerp(startRot.z, targetRot.z, easeOutCubic(progress));

        if (progress < 1) {
          requestAnimationFrame(spin);
        } else {
          onComplete();
        }
      }
      spin();
    }

    // Easing function for smooth stop
    function easeOutCubic(t) {
      return 1 - Math.pow(1 - t, 3);
    }

    async function askQuestion() {
      const questionInput = document.getElementById('question');
      const question = questionInput.value.trim();
      if (!question) return;

      // Clear input for next question
      questionInput.value = '';

      // Get answer from AI or fallback
      let answer = null;
      try {
        answer = await getAIAnswer(question);
        if (!answer) throw new Error("Fallback");
      } catch {
        answer = standardAnswers[Math.floor(Math.random() * standardAnswers.length)];
      }

      // Animate die then show answer
      animateDie(answer, () => drawAnswer(answer));
    }

    async function getAIAnswer(question) {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer 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"
        },
        body: JSON.stringify({
          model: "gpt-4o",
          messages: [
            { role: "system", content: "You are a magic 8 ball. Only answer using short standard phrases." },
            { role: "user", content: question }
          ],
          max_tokens: 30,
          temperature: 0.8
        })
      });
      const data = await response.json();
      return data.choices?.[0]?.message?.content?.trim() || null;
    }

    // Animate loop
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    // Position die inside ball
    die.position.set(0, 0, 0);

    animate();

    // Responsive resizing
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
