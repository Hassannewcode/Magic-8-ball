<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D AI Magic 8 Ball</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@600&display=swap');
    html, body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #eee;
      user-select: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: 100vh;
      position: relative;
    }
    #overlay {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 90vw;
      max-width: 600px;
      text-align: center;
      z-index: 10;
      pointer-events: auto;
      transition: bottom 1s ease, top 1s ease;
    }
    #overlay.raised {
      bottom: auto;
      top: 30px;
      transform: translateX(-50%);
    }
    #question {
      font-size: 20px;
      font-weight: 600;
      padding: 14px 18px;
      width: 300px;
      max-width: 80vw;
      border-radius: 12px;
      border: none;
      outline: none;
      background: #111;
      color: #eee;
      box-shadow: 0 0 8px #0000ff66;
      text-align: center;
      transition: box-shadow 0.3s ease;
    }
    #question:focus {
      box-shadow: 0 0 15px #007bffcc;
    }
    button {
      font-size: 20px;
      font-weight: 700;
      padding: 14px 24px;
      margin-left: 12px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: linear-gradient(145deg, #0057ff, #003dbb);
      color: #fff;
      box-shadow: 0 0 12px #0057ffcc;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    button:hover, button:focus {
      background: linear-gradient(145deg, #003dbb, #001f70);
      box-shadow: 0 0 20px #0040ffee;
    }
    #canvas {
      display: block;
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="overlay">
    <input id="question" type="text" placeholder="Ask your question..." autocomplete="off" />
    <button onclick="askQuestion()">Ask</button>
  </div>
  <canvas id="canvas"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r155/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/OrbitControls.min.js"></script>

  <script>
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0.5, 6);

    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("canvas"), antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x000000);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.1;
    controls.minDistance = 4;
    controls.maxDistance = 10;
    controls.enablePan = false;

    // Lights
    const pointLight = new THREE.PointLight(0xffffff, 1.5);
    pointLight.position.set(5, 5, 5);
    scene.add(pointLight);
    scene.add(new THREE.AmbientLight(0x222222));

    // Magic 8 Ball sphere
    const ballGeometry = new THREE.SphereGeometry(1.5, 128, 128);
    const ballMaterial = new THREE.MeshPhysicalMaterial({
      color: 0x111111,
      metalness: 0.5,
      roughness: 0.7,
      clearcoat: 1,
      clearcoatRoughness: 0.1,
      reflectivity: 0.5,
    });
    const ball = new THREE.Mesh(ballGeometry, ballMaterial);
    scene.add(ball);

    // Front window circle (glowing)
    const windowGeometry = new THREE.CircleGeometry(0.65, 64);
    const windowMaterial = new THREE.MeshPhysicalMaterial({
      color: 0x0022ff,
      emissive: 0x0044ff,
      emissiveIntensity: 0.5,
      roughness: 0.2,
      metalness: 0.3,
      transparent: true,
      opacity: 0.85,
      side: THREE.DoubleSide,
      clearcoat: 1,
      clearcoatRoughness: 0.1,
    });
    const ballWindow = new THREE.Mesh(windowGeometry, windowMaterial);
    ballWindow.position.z = 1.52;
    ballWindow.rotation.x = -Math.PI / 2;
    ball.add(ballWindow);

    // Internal icosahedron (the die)
    const dieGeometry = new THREE.IcosahedronGeometry(0.6);
    const dieMaterial = new THREE.MeshPhysicalMaterial({
      color: 0x0033cc,
      metalness: 0.7,
      roughness: 0.3,
      clearcoat: 1,
      clearcoatRoughness: 0.1,
      flatShading: true,
      emissive: 0x001122,
      emissiveIntensity: 0.6
    });
    const die = new THREE.Mesh(dieGeometry, dieMaterial);
    scene.add(die);

    // Canvas texture for answer text
    const textCanvas = document.createElement('canvas');
    textCanvas.width = 512;
    textCanvas.height = 512;
    const ctx = textCanvas.getContext('2d');
    const textTexture = new THREE.CanvasTexture(textCanvas);

    const textPlaneMaterial = new THREE.MeshBasicMaterial({ map: textTexture, transparent: true, opacity: 0 });
    const textPlane = new THREE.Mesh(new THREE.PlaneGeometry(1.2, 1.2), textPlaneMaterial);
    textPlane.position.z = 1.53;
    ball.add(textPlane);

    // Glow effect for the window when lighting up
    let glowIntensity = 0;
    function updateWindowGlow() {
      windowMaterial.emissiveIntensity = 0.5 + glowIntensity * 1.5;
      ballWindow.material.emissiveIntensity = windowMaterial.emissiveIntensity;
    }

    function drawAnswer(text) {
      ctx.clearRect(0, 0, textCanvas.width, textCanvas.height);

      const gradient = ctx.createRadialGradient(textCanvas.width/2, textCanvas.height/2, 50, textCanvas.width/2, textCanvas.height/2, 220);
      gradient.addColorStop(0, 'rgba(0,68,255,0.8)');
      gradient.addColorStop(1, 'rgba(0,0,0,0)');

      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, textCanvas.width, textCanvas.height);

      ctx.fillStyle = 'white';
      ctx.font = 'bold 48px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(0,0,0,0.7)';
      ctx.shadowBlur = 10;
      ctx.fillText(text, textCanvas.width/2, textCanvas.height/2);

      textTexture.needsUpdate = true;
    }

    const standardAnswers = [
      "It is certain", "It is decidedly so", "Without a doubt", "Yes, definitely",
      "You may rely on it", "As I see it, yes", "Most likely", "Outlook good",
      "Yes", "Signs point to yes", "Reply hazy, try again", "Ask again later",
      "Better not tell you now", "Cannot predict now", "Concentrate and ask again",
      "Don't count on it", "My reply is no", "My sources say no",
      "Outlook not so good", "Very doubtful"
    ];

    // Animate the die spin with easing
    function animateDie(onComplete) {
      const startRot = die.rotation.clone();
      const spins = 5 + Math.random() * 4; // 5-9 spins
      const targetRot = new THREE.Euler(
        startRot.x + Math.PI * 2 * spins * (Math.random() > 0.5 ? 1 : -1),
        startRot.y + Math.PI * 2 * spins * (Math.random() > 0.5 ? 1 : -1),
        startRot.z + Math.PI * 2 * spins * (Math.random() > 0.5 ? 1 : -1)
      );

      let progress = 0;
      const duration = 1700; // ms
      const startTime = performance.now();

      function spin() {
        const now = performance.now();
        progress = (now - startTime) / duration;
        if (progress > 1) progress = 1;

        die.rotation.x = THREE.MathUtils.lerp(startRot.x, targetRot.x, easeOutCubic(progress));
        die.rotation.y = THREE.MathUtils.lerp(startRot.y, targetRot.y, easeOutCubic(progress));
        die.rotation.z = THREE.MathUtils.lerp(startRot.z, targetRot.z, easeOutCubic(progress));

        if (progress < 1) {
          requestAnimationFrame(spin);
        } else {
          onComplete();
        }
      }
      spin();
    }

    function easeOutCubic(t) {
      return 1 - Math.pow(1 - t, 3);
    }

    async function askQuestion() {
      const overlay = document.getElementById('overlay');
      const questionInput = document.getElementById('question');
      const question = questionInput.value.trim();
      if (!question) return;

      questionInput.disabled = true;
      questionInput.style.opacity = '0.5';
      document.querySelector('button').disabled = true;
      document.querySelector('button').style.opacity = '0.5';

      // Animate question input upwards to top
      overlay.classList.add('raised');

      // Animate 8 ball glow up
      glowIntensity = 0;
      const glowDuration = 1000;
      const glowStart = performance.now();
      function glowUp() {
        const now = performance.now();
        const t = Math.min((now - glowStart) / glowDuration, 1);
        glowIntensity = t;
        updateWindowGlow();
        if (t < 1) requestAnimationFrame(glowUp);
      }
      glowUp();

      // Get answer from AI or fallback
      let answer = null;
      try {
        answer = await getAIAnswer(question);
        if (!answer) throw new Error("Fallback");
      } catch {
        answer = standardAnswers[Math.floor(Math.random() * standardAnswers.length)];
      }

      // Spin die then show answer
      animateDie(() => {
        drawAnswer(answer);
        fadeInAnswer();
        // After showing answer, re-enable input after delay
        setTimeout(() => {
          questionInput.disabled = false;
          questionInput.style.opacity = '1';
          document.querySelector('button').disabled = false;
          document.querySelector('button').style.opacity = '1';
        }, 1500);
      });
    }

    // Fade-in answer text
    function fadeInAnswer() {
      let opacity = 0;
      textPlane.material.opacity = 0;
      function fade() {
        opacity += 0.02;
        if (opacity > 1) opacity = 1;
        textPlane.material.opacity = opacity;
        if (opacity < 1) {
          requestAnimationFrame(fade);
        }
      }
      fade();
    }

    async function getAIAnswer(question) {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer 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"
        },
        body: JSON.stringify({
          model: "gpt-4o",
          messages: [
            { role: "system", content: "You are a magic 8 ball. Only answer using short standard phrases." },
            { role: "user", content: question }
          ],
          max_tokens: 30,
          temperature: 0.8
        })
      });
      const data = await response.json();
      return data.choices?.[0]?.message?.content?.trim() || null;
    }

    // Animate loop
    function animate() {
      requestAnimationFrame(animate);
      controls.update();

      // Slow gentle rotation of the ball and die
      ball.rotation.y += 0.002;
      die.rotation.x += 0.004;
      die.rotation.y += 0.006;

      renderer.render(scene, camera);
    }

    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
