<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3D Magic 8 Ball</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@600&display=swap');

  html, body {
    margin: 0; padding: 0; overflow: hidden;
    height: 100vh;
    background-color: #000;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #eee;
    user-select: none;
  }

  #question-container {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    max-width: 90vw;
    width: 500px;
    text-align: center;
    cursor: text;
    z-index: 20;
    user-select: text;
  }

  #question-text {
    font-size: 28px;
    font-weight: 600;
    color: #eee;
    margin: 0;
    text-shadow: 0 0 8px rgba(10, 132, 255, 0.8);
    user-select: text;
    word-break: break-word;
    min-height: 36px;
  }

  #underline {
    margin-top: 6px;
    border-bottom: 2px solid #1a1a1a;
    width: 100%;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
  }

  #helper-text {
    font-size: 14px;
    font-style: italic;
    color: #555;
    margin-top: 8px;
    user-select: none;
    opacity: 1;
    transition: opacity 0.6s ease;
  }

  #input-field {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 90vw;
    max-width: 500px;
    font-size: 20px;
    font-weight: 600;
    background: transparent;
    border: none;
    border-bottom: 2px solid #444;
    color: #eee;
    padding: 6px 8px;
    outline: none;
    text-align: center;
    caret-color: #0a84ff;
    user-select: text;
    transition: border-color 0.3s ease;
    cursor: text;
  }

  #input-field::placeholder {
    color: #444;
  }
  #input-field:focus {
    border-bottom-color: #0a84ff;
  }

  /* Canvas full screen */
  #canvas {
    display: block;
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    user-select: none;
    touch-action: none;
  }
</style>
</head>
<body>
  <div id="question-container" aria-live="polite" aria-atomic="true" role="region">
    <p id="question-text" aria-live="assertive" aria-atomic="true"></p>
    <div id="underline"></div>
    <div id="helper-text">*press enter to ask*</div>
  </div>
  <input id="input-field" type="text" autocomplete="off" placeholder="Type your question here..." aria-label="Ask your question" />

  <canvas id="canvas" aria-label="3D Magic 8 Ball"></canvas>

  <!-- THREE.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

  <script>
    (() => {
      const answers = [
        "It is certain", "It is decidedly so", "Without a doubt", "Yes, definitely",
        "You may rely on it", "As I see it, yes", "Most likely", "Outlook good",
        "Yes", "Signs point to yes", "Reply hazy, try again", "Ask again later",
        "Better not tell you now", "Cannot predict now", "Concentrate and ask again",
        "Don't count on it", "My reply is no", "My sources say no",
        "Outlook not so good", "Very doubtful"
      ];

      // === THREE.js Setup ===
      const scene = new THREE.Scene();

      // Camera setup
      const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(0, 0.6, 6);

      // Renderer
      const renderer = new THREE.WebGLRenderer({
        canvas: document.getElementById('canvas'),
        antialias: true,
        alpha: false,
        powerPreference: "high-performance",
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x000000);

      // Lighting
      const ambientLight = new THREE.AmbientLight(0x111111);
      scene.add(ambientLight);

      const pointLight = new THREE.PointLight(0xffffff, 1.5);
      pointLight.position.set(6, 6, 6);
      scene.add(pointLight);

      // Add subtle rim light for better silhouette
      const rimLight = new THREE.DirectionalLight(0x3399ff, 0.3);
      rimLight.position.set(-5, 5, 5);
      scene.add(rimLight);

      // Magic 8 Ball base sphere with polished glossy black
      const ballGeometry = new THREE.SphereGeometry(1.5, 128, 128);
      const ballMaterial = new THREE.MeshPhysicalMaterial({
        color: 0x101010,
        metalness: 0.8,
        roughness: 0.25,
        clearcoat: 1,
        clearcoatRoughness: 0.05,
        reflectivity: 0.8,
        envMapIntensity: 1,
      });
      const ball = new THREE.Mesh(ballGeometry, ballMaterial);
      scene.add(ball);

      // Glowing front window - translucent blue glass look
      const windowGeometry = new THREE.CircleGeometry(0.65, 64);
      const windowMaterial = new THREE.MeshPhysicalMaterial({
        color: 0x0026ff,
        emissive: 0x003eff,
        emissiveIntensity: 0.6,
        roughness: 0.15,
        metalness: 0.4,
        transparent: true,
        opacity: 0.9,
        side: THREE.DoubleSide,
        clearcoat: 1,
        clearcoatRoughness: 0.05,
      });
      const ballWindow = new THREE.Mesh(windowGeometry, windowMaterial);
      ballWindow.position.z = 1.52;
      ballWindow.rotation.x = -Math.PI / 2;
      ball.add(ballWindow);

      // Inner icosahedron (the die) with emissive edges
      const dieGeometry = new THREE.IcosahedronGeometry(0.6);
      const dieMaterial = new THREE.MeshPhysicalMaterial({
        color: 0x0047b3,
        metalness: 0.7,
        roughness: 0.2,
        clearcoat: 1,
        clearcoatRoughness: 0.05,
        flatShading: true,
        emissive: 0x001933,
        emissiveIntensity: 0.8
      });
      const die = new THREE.Mesh(dieGeometry, dieMaterial);
      scene.add(die);

      // Text canvas for answer display on the window
      const textCanvas = document.createElement('canvas');
      textCanvas.width = 512;
      textCanvas.height = 512;
      const ctx = textCanvas.getContext('2d');
      const textTexture = new THREE.CanvasTexture(textCanvas);
      textTexture.minFilter = THREE.LinearFilter;
      textTexture.magFilter = THREE.LinearFilter;

      // Plane to show the answer text, slightly in front of window
      const textPlaneMaterial = new THREE.MeshBasicMaterial({ map: textTexture, transparent: true, opacity: 0 });
      const textPlane = new THREE.Mesh(new THREE.PlaneGeometry(1.2, 1.2), textPlaneMaterial);
      textPlane.position.z = 1.53;
      ball.add(textPlane);

      // Text drawing helper (wraps text nicely)
      function drawAnswer(text) {
        ctx.clearRect(0, 0, textCanvas.width, textCanvas.height);

        // Subtle radial glow behind text
        const gradient = ctx.createRadialGradient(textCanvas.width/2, textCanvas.height/2, 50, textCanvas.width/2, textCanvas.height/2, 220);
        gradient.addColorStop(0, 'rgba(0,68,255,0.85)');
        gradient.addColorStop(1, 'rgba(0,0,0,0)');

        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, textCanvas.width, textCanvas.height);

        // Draw answer text
        ctx.fillStyle = 'white';
        ctx.font = 'bold 48px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = 'rgba(0,0,0,0.9)';
        ctx.shadowBlur = 12;
        wrapText(ctx, text, textCanvas.width / 2, textCanvas.height / 2, 440, 52);

        textTexture.needsUpdate = true;
      }

      // Text wrapping utility (fixed edge cases)
      function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        const words = text.split(' ');
        let line = '';
        let lines = [];
        for (let n = 0; n < words.length; n++) {
          const testLine = line + words[n] + ' ';
          const testWidth = ctx.measureText(testLine).width;
          if (testWidth > maxWidth && n > 0) {
            lines.push(line.trim());
            line = words[n] + ' ';
          } else {
            line = testLine;
          }
        }
        lines.push(line.trim());

        // Calculate vertical starting point for vertically centered text
        let startY = y - (lines.length - 1) * lineHeight / 2;
        lines.forEach((line, i) => {
          ctx.fillText(line, x, startY + (i * lineHeight));
        });
      }

      // Die spin animation
      function animateDie(onComplete) {
        const startRot = { x: die.rotation.x, y: die.rotation.y, z: die.rotation.z };
        const spins = 5 + Math.random() * 4;
        const targetRot = {
          x: startRot.x + Math.PI * 2 * spins * (Math.random() > 0.5 ? 1 : -1),
          y: startRot.y + Math.PI * 2 * spins * (Math.random() > 0.5 ? 1 : -1),
          z: startRot.z + Math.PI * 2 * spins * (Math.random() > 0.5 ? 1 : -1)
        };

        gsap.to(die.rotation, {
          x: targetRot.x,
          y: targetRot.y,
          z: targetRot.z,
          duration: 1.8,
          ease: "power4.inOut",
          onComplete: onComplete
        });
      }

      // Window glow pulse animation
      function glowPulse() {
        gsap.to(ballWindow.material, {
          emissiveIntensity: 2.2,
          duration: 0.6,
          yoyo: true,
          repeat: 3,
          ease: "sine.inOut"
        });
      }

      // Fade in answer text on window
      function fadeInAnswer() {
        gsap.fromTo(textPlane.material, {opacity: 0}, {opacity: 1, duration: 1.4, ease: "power2.inOut"});
      }

      // UI Elements
      const input = document.getElementById('input-field');
      const questionText = document.getElementById('question-text');
      const questionContainer = document.getElementById('question-container');
      const helperText = document.getElementById('helper-text');

      // Animate question container moving from bottom to top
      function animateQuestionUp() {
        return gsap.to(questionContainer, {
          duration: 1.2,
          ease: "power2.out",
          bottom: "auto",
          top: "30px",
          onStart: () => { helperText.style.opacity = 0; }
        });
      }
      // Animate question container down and reset UI
      function animateQuestionDown() {
        return gsap.to(questionContainer, {
          duration: 1.2,
          ease: "power2.inOut",
          top: "auto",
          bottom: "40px",
          onComplete: () => {
            helperText.style.opacity = 1;
            input.value = "";
            input.disabled = false;
            questionText.textContent = "";
            gsap.to(textPlane.material, {opacity: 0, duration: 0.5});
            input.focus();
          }
        });
      }

      // Main ask function
      async function ask() {
        const question = input.value.trim();
        if (!question) return;

        input.disabled = true;
        questionText.textContent = question;
        await animateQuestionUp();

        glowPulse();

        const answer = answers[Math.floor(Math.random() * answers.length)];
        animateDie(() => {
          drawAnswer(answer);
          fadeInAnswer();

          // Reset UI after 3.5 seconds
          setTimeout(() => {
            animateQuestionDown();
          }, 3500);
        });
      }

      // Enter key handler
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          ask();
        }
      });

      // Animate loop for 3D objects
      function animate() {
        requestAnimationFrame(animate);

        // Slow, subtle rotation for natural life
        ball.rotation.y += 0.003;
        die.rotation.x += 0.005;
        die.rotation.y += 0.007;

        // Idle subtle pulse glow on the window material emissiveIntensity
        const pulse = 1.1 + Math.sin(Date.now() * 0.002) * 0.2;
        ballWindow.material.emissiveIntensity = pulse;

        renderer.render(scene, camera);
      }
      animate();

      // Responsive handling
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // Focus input on page load for usability
      window.onload = () => {
        input.focus();
      };
    })();
  </script>
</body>
</html>
